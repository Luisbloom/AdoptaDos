<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>üìä Ver y Gestionar ‚Äî Informe Completo</title>
  <link rel="stylesheet" href="css/style.css">
  <style>
    /* Estilos adicionales espec√≠ficos para esta p√°gina */
    .acciones-principales {
      display: flex;
      gap: 1rem;
      flex-wrap: wrap;
      margin: 1.5rem 0;
    }
    .btn-action {
      display: inline-block;
      padding: 0.75rem 1.25rem;
      background: #3498db;
      color: white;
      text-decoration: none;
      border-radius: 6px;
      font-weight: bold;
    }
    .btn-action:hover { background: #2980b9; }
    .btn-action.red { background: #e74c3c; }
    .btn-action.red:hover { background: #c0392b; }
    .btn-action.green { background: #27ae60; }
    .btn-action.green:hover { background: #219653; }
    .error {
      background: #fdf2f2;
      border-left: 4px solid #e74c3c;
      padding: 1rem;
      margin: 1rem 0;
      border-radius: 4px;
    }
    .success {
      background: #f2fdf5;
      border-left: 4px solid #27ae60;
      padding: 1rem;
      margin: 1rem 0;
      border-radius: 4px;
    }
  </style>
</head>
<body>
  <header>
    <h1>üìä Ver y Gestionar ‚Äî Informe Completo</h1>
  </header>

  <nav>
    <ul>
      <li><a href="index.html">üè† Inicio</a></li>
      <li><a href="registro-usuario.html">üìù Registrar Usuario</a></li>
      <li><a href="registro-animal.html">üê∂ Registrar Animal</a></li>
      <li><a href="adopcion-pareja.html">‚ù§Ô∏è Adoptar en Pareja</a></li>
    </ul>
  </nav>

  <main>
    <div class="acciones-principales">
      <a href="registro-usuario.html" class="btn-action">üë§ Nuevo Usuario</a>
      <a href="registro-animal.html" class="btn-action green">üêæ Nuevo Animal</a>
      <a href="adopcion-pareja.html" class="btn-action red">‚ù§Ô∏è Nueva Adopci√≥n</a>
    </div>

    <div class="nota">
      Esta p√°gina carga y transforma <code>data/adopciones.xml</code> usando <code>xslt/adopciones.xsl</code>.
      <br>‚ö†Ô∏è Debe ejecutarse con un servidor HTTP (ej. <code>npx serve</code>).
    </div>

    <div id="visor">
      <p>Cargando informe completo‚Ä¶</p>
    </div>

    <div class="nota" style="margin-top: 2rem;">
      <strong>üí° Consejo:</strong> Cada vez que registras un usuario, animal o adopci√≥n, los datos se guardan
      en <code>localStorage</code> y se sincronizan con el XML. Recarga esta p√°gina para ver los cambios.
    </div>
  </main>

  <footer>
    <p>¬© 2025 Adopta en Pareja ‚Äî Proyecto de Lenguaje de Marcas | Luis Miguel Pablos Orge</p>
  </footer>

  <script>
    document.addEventListener('DOMContentLoaded', function() {
      const visor = document.getElementById('visor');
      if (!visor) return;

      function procesarXML(xmlStr) {
        const parser = new DOMParser();
        const xml = parser.parseFromString(xmlStr, "application/xml");
        
        const parserError = xml.querySelector("parsererror");
        if (parserError) {
          visor.innerHTML = `
            <div class="error">
              <h3>‚ùå Error en la estructura XML</h3>
              <p><strong>Detalle:</strong> ${parserError.textContent}</p>
              <p>Revisa los datos ingresados desde los formularios.</p>
            </div>`;
          console.error("XML parse error:", parserError.textContent);
          return;
        }

        // Cargar XSLT
        fetch('xslt/adopciones.xsl')
          .then(response => {
            if (!response.ok) throw new Error(`XSLT no encontrado: ${response.status}`);
            return response.text();
          })
          .then(xslStr => {
            const xsl = parser.parseFromString(xslStr, "application/xml");
            const xslError = xsl.querySelector("parsererror");
            if (xslError) {
              throw new Error(`Error en adopciones.xsl: ${xslError.textContent}`);
            }

            // Transformar
            const xsltProcessor = new XSLTProcessor();
            xsltProcessor.importStylesheet(xsl);
            const fragment = xsltProcessor.transformToFragment(xml, document);

            visor.innerHTML = '';
            visor.appendChild(fragment);
            
            // Mensaje de √©xito en consola
            console.log("‚úÖ Informe generado con √©xito. Datos cargados:");
            console.log("- Usuarios:", xml.querySelectorAll('usuarios usuario').length);
            console.log("- Animales:", xml.querySelectorAll('animales animal').length);
            console.log("- Adopciones:", xml.querySelectorAll('adopciones-realizadas adopcion').length);
          })
          .catch(err => {
            visor.innerHTML = `
              <div class="error">
                <h3>‚ùå Error en la transformaci√≥n</h3>
                <p><strong>Tipo:</strong> ${err.name}</p>
                <p><strong>Mensaje:</strong> ${err.message}</p>
                <p>Verifica que <code>xslt/adopciones.xsl</code> exista y sea v√°lido.</p>
              </div>`;
            console.error("XSLT error:", err);
          });
      }

      // Intentar desde localStorage primero (m√°s r√°pido)
      let xmlStr = localStorage.getItem('adopciones.xml');
      
      if (xmlStr) {
        visor.innerHTML = '<p class="success">‚úÖ Cargando datos desde cach√© (localStorage)‚Ä¶</p>';
        setTimeout(() => procesarXML(xmlStr), 200);
      } else {
        visor.innerHTML = '<p>üîÑ Cargando desde <code>data/adopciones.xml</code>‚Ä¶</p>';
        
        fetch('data/adopciones.xml')
          .then(response => {
            if (!response.ok) throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            return response.text();
          })
          .then(xmlContent => {
            localStorage.setItem('adopciones.xml', xmlContent);
            visor.innerHTML = '<p class="success">‚úÖ Datos cargados y cacheados. Generando informe‚Ä¶</p>';
            setTimeout(() => procesarXML(xmlContent), 300);
          })
          .catch(err => {
            visor.innerHTML = `
              <div class="error">
                <h3>‚ùå No se pudo cargar los datos</h3>
                <p><strong>Error:</strong> ${err.message}</p>
                <ul>
                  <li>¬øExiste el archivo <code>data/adopciones.xml</code>?</li>
                  <li>¬øEst√°s usando un servidor local? (No sirve abrir con doble clic)</li>
                </ul>
              </div>`;
            console.error("Fetch error:", err);
          });
      }
    });
  </script>
</body>
</html>