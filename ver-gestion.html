<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>üìä Ver y Gestionar Adopciones</title>
  <link rel="stylesheet" href="css/style.css">
</head>
<body>
  <header>
    <h1>üìä Ver y Gestionar Adopciones</h1>
  </header>

  <nav>
    <ul>
      <li><a href="index.html">üè† Inicio</a></li>
      <li><a href="registro-usuario.html">üìù Registrar Usuario</a></li>
      <li><a href="registro-animal.html">üê∂ Registrar Animal</a></li>
      <li><a href="adopcion-pareja.html">‚ù§Ô∏è Adoptar en Pareja</a></li>
    </ul>
  </nav>

  <main>
    <div class="nota">
      Esta p√°gina carga el archivo <code>data/adopciones.xml</code> y aplica la transformaci√≥n <code>xslt/adopciones.xsl</code>.
      <br>‚ö†Ô∏è Debe ejecutarse con un servidor HTTP (ej. <code>npx serve</code>).
    </div>

    <div id="visor">
      <p>Cargando datos desde XML‚Ä¶</p>
    </div>
  </main>

  <footer>
    <p>¬© 2025 Adopta en Pareja ‚Äî Proyecto de Lenguaje de Marcas</p>
  </footer>

  <script>
    document.addEventListener('DOMContentLoaded', function() {
      const visor = document.getElementById('visor');
      if (!visor) return;

      // Funci√≥n principal para procesar el XML
      function procesarXML(xmlStr) {
        const parser = new DOMParser();
        const xml = parser.parseFromString(xmlStr, "application/xml");
        
        // Verificar errores en XML
        const parserError = xml.querySelector("parsererror");
        if (parserError) {
          visor.innerHTML = `
            <div class="error">
              <h3>‚ùå Error en adopciones.xml</h3>
              <p>${parserError.textContent}</p>
              <p>Revisa la estructura del XML generado.</p>
            </div>`;
          console.error("XML parse error:", parserError.textContent);
          return;
        }

        // Cargar y aplicar XSLT
        fetch('xslt/adopciones.xsl')
          .then(response => {
            if (!response.ok) {
              throw new Error(`XSLT no encontrado o error HTTP: ${response.status}`);
            }
            return response.text();
          })
          .then(xslStr => {
            const xsl = parser.parseFromString(xslStr, "application/xml");
            const xslError = xsl.querySelector("parsererror");
            if (xslError) {
              throw new Error(`Error en adopciones.xsl: ${xslError.textContent}`);
            }

            // Aplicar transformaci√≥n
            const xsltProcessor = new XSLTProcessor();
            xsltProcessor.importStylesheet(xsl);
            const resultDocument = xsltProcessor.transformToFragment(xml, document);

            // Limpiar y mostrar resultado
            visor.innerHTML = '';
            visor.appendChild(resultDocument);
            
            console.log("‚úÖ XML y XSLT cargados y transformados con √©xito.");
          })
          .catch(err => {
            visor.innerHTML = `
              <div class="error">
                <h3>‚ùå Error en la transformaci√≥n XSLT</h3>
                <p><strong>Mensaje:</strong> ${err.message}</p>
                <p>Verifica que <code>xslt/adopciones.xsl</code> exista y sea v√°lido.</p>
              </div>`;
            console.error("XSLT error:", err);
          });
      }

      // Paso 1: Intentar cargar desde localStorage (m√°s r√°pido, datos actualizados)
      let xmlStr = localStorage.getItem('adopciones.xml');
      
      if (xmlStr) {
        console.log("‚úÖ Cargando XML desde localStorage");
        visor.innerHTML = '<p>‚úÖ Cargando datos desde cach√©‚Ä¶</p>';
        setTimeout(() => procesarXML(xmlStr), 100);
      } 
      // Paso 2: Si no hay en localStorage, cargar desde data/adopciones.xml
      else {
        console.log("üîÑ Cargando XML desde data/adopciones.xml");
        visor.innerHTML = '<p>üîÑ Cargando datos desde data/adopciones.xml‚Ä¶</p>';
        
        fetch('data/adopciones.xml')
          .then(response => {
            if (!response.ok) {
              throw new Error(`No se pudo cargar data/adopciones.xml: ${response.status} ${response.statusText}`);
            }
            return response.text();
          })
          .then(xmlContent => {
            // Guardar en localStorage para futuras visitas
            localStorage.setItem('adopciones.xml', xmlContent);
            console.log("‚úÖ XML guardado en localStorage");
            procesarXML(xmlContent);
          })
          .catch(err => {
            visor.innerHTML = `
              <div class="error">
                <h3>‚ùå No se pudo cargar los datos</h3>
                <p><strong>Error:</strong> ${err.message}</p>
                <p>Aseg√∫rate de que:</p>
                <ul>
                  <li>El archivo <code>data/adopciones.xml</code> existe</li>
                  <li>Est√°s usando un servidor HTTP (ej. <code>npx serve</code>)</li>
                </ul>
              </div>`;
            console.error("Fetch XML error:", err);
          });
      }
    });
  </script>
</body>
</html>